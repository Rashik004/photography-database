#!/usr/bin/perl -wT

# Interactive user interface for interacting with the photography database

use strict;
use warnings;
use Switch;
use DBI;
use DBD::mysql;

# Will be called like:
# - photodb film add
# - photodb camera view

# Read in command
my $command = $ARGV[0] or &nocommand;

switch ($command) {
	case 'film' {
		print "you chose film\n";
		my $subcommand = $ARGV[1] or &nosubcommand;
		switch ($subcommand) {
			case 'add' {
				# Add a newly-purchased film
				my %data;
				$data{'filmstock'} = &listchoices('filmstock', "select filmstock_id as id, name as opt from FILMSTOCK");
				$data{'format'} = &listchoices('format', "select format_id as id, format as opt from FORMAT");
			}
			case 'load' {
				# Load a film into a camera
				&notimplemented;
			}
			case 'develop' {
				# Develop a film
				&notimplemented;
			}
			case 'help' {
				&notimplemented;
			}
			else {
				&notimplemented;
			}
		}
	}
	case 'camera' {
		print "you chose camera\n";
		my $subcommand = $ARGV[1] or &nosubcommand;
		switch ($subcommand) {
			case 'add' {
				&notimplemented;
			}
			case 'show-lenses' {
				&notimplemented;
			}
			case 'help' {
				&notimplemented;
			}
			else {
				&notimplemented;
			}
		}
	}
	case 'negative' {
		print "you chose negative\n";
		my $subcommand = $ARGV[1] or &nosubcommand;
		switch ($subcommand) {
			case 'add' {
				# Add a single neg to a film
				&notimplemented;
			}
			case 'bulk-add' {
				# Add lots of negatives to a film, maybe asks if they were all shot with the same lens
				&notimplemented;
			}
			case 'help' {
				&notimplemented;
			}
			else {
				&notimplemented;
			}
		}
	}
	case 'lens' {
		print "you chose lens\n";
		my $subcommand = $ARGV[1] or &nosubcommand;
		switch ($subcommand) {
			case 'add' {
				&notimplemented;
			}
			case 'help' {
				&notimplemented;
			}
			else {
				&notimplemented;
			}
		}
	}
	case 'print' {
		print "you chose lens\n";
		my $subcommand = $ARGV[1] or &nosubcommand;
		switch ($subcommand) {
			case 'add' {
				&notimplemented;
			}
			case 'tone' {
				&notimplemented;
			}
			case 'help' {
				&notimplemented;
			}
			else {
				&notimplemented;
			}
		}
	}
	case 'help' {
		&help;
	}
	else {
		&nocommand;
	}
}

# Print a warning that this command/subcommand is not yet implemented
sub notimplemented {
	die "This command or subcommand is not yet implemented.\n";
}

# Quit if no command is given
sub nocommand {
	die "Please enter a valid command. Use '$0 help' for list of commands.\n";
}

# Quit if no subcommand is given
sub nosubcommand {
	die "Please enter a valid subcommand. Use '$0 $command help' for list of subcommands.\n";
}

# Print help message
sub help {
	my $command = shift;
        my $subcommand = shift;

	print "Photography Database UI\n";
	print "\n";
	print "$0 <command> <subcommand>\n";
	print "e.g. $0 film add\n";
	print "\n";
	print "Valid commands: film, camera, negative, lens, print, help\n";
	exit;
}

# List arbitrary choices and return ID of the selected one
sub listchoices {
	my $keyword = shift;
	my $query = shift;

	print "Please select a $keyword from the list:\n";

	my $db = &db;
	my $sth = $db->prepare($query) or die "Couldn't prepare statement: " . $db->errstr;
	my $rows = $sth->execute();

	$sth->execute();
	my $ref;

	while ($ref = $sth->fetchrow_hashref) {
		print "\t$ref->{id}\t$ref->{opt}\n";
	}

	# Wait for input
	my $input = prompt('', "Please select a $keyword");

	# Validate input
	$input =~ s/[^0-9]//g;

	# Return input
	return $input;
}

# Insert a record into any table
sub newrecord {
	# Read in hash of values
	my $data = shift;

	# Read in table name
	my $table = shift;

	# Build query
	# Execute query
	# Display inserted row
}

# Read in arbitrary field
sub readvalue {
	my $prompt = shift;
	my $type = shift;

	# Prompt for input

	# Validate input
	switch ($type) {
		case 'int' {}
		case 'str' {}
	}

	# Return input
}

# Connect to the database
sub db {
	#TODO: Move DB settings out to config file
	my $dsn = "DBI:mysql:database=photography;host=192.168.0.2";
	my $dbh = DBI->connect($dsn, 'photography','photography') or die "Couldn't connect to database: " . DBI->errstr;
	return $dbh;
}

# prompt($default, $prompt_string)
sub prompt {
        my $default = shift || "";
        my $prompt = shift;

        print "$prompt [$default]: ";
        my $input = <STDIN>;
        chomp($input);

        my $rv = ($input eq "") ? $default:$input;
        if ($rv eq "") {
                print "ERR: required parameter '$prompt' not specified.  Quitting!\n\n";
                exit;
        }
        return $rv;
}
